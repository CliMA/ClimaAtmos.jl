<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Equations · ClimaAtmos.jl</title><meta name="title" content="Equations · ClimaAtmos.jl"/><meta property="og:title" content="Equations · ClimaAtmos.jl"/><meta property="twitter:title" content="Equations · ClimaAtmos.jl"/><meta name="description" content="Documentation for ClimaAtmos.jl."/><meta property="og:description" content="Documentation for ClimaAtmos.jl."/><meta property="twitter:description" content="Documentation for ClimaAtmos.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaAtmos.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../contributor_guide/">Contributor Guide</a></li><li class="is-active"><a class="tocitem" href>Equations</a><ul class="internal"><li><a class="tocitem" href="#Prognostic-variables"><span>Prognostic variables</span></a></li><li><a class="tocitem" href="#Operators"><span>Operators</span></a></li><li><a class="tocitem" href="#Auxiliary-and-derived-quantities"><span>Auxiliary and derived quantities</span></a></li><li><a class="tocitem" href="#Equations-and-discretizations"><span>Equations and discretizations</span></a></li><li><a class="tocitem" href="#Microphysics-source-terms"><span>Microphysics source terms</span></a></li></ul></li><li><a class="tocitem" href="../edmf_equations/">EDMF Equations</a></li><li><a class="tocitem" href="../diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../available_diagnostics/">Available Diagnostics</a></li><li><a class="tocitem" href="../diagnostic_edmf_equations/">Diagnostic EDMF Equations</a></li><li><a class="tocitem" href="../gravity_wave/">Gravity Wave Drag Parameterizations</a></li><li><a class="tocitem" href="../radiative_equilibrium/">Radiative Equilibrium</a></li><li><a class="tocitem" href="../repl_scripts/">REPL scripts</a></li><li><a class="tocitem" href="../config/">Configuration</a></li><li><a class="tocitem" href="../parameters/">Parameters</a></li><li><a class="tocitem" href="../longruns/">Longruns</a></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Equations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Equations</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaAtmos.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaAtmos.jl/blob/main/docs/src/equations.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Equations"><a class="docs-heading-anchor" href="#Equations">Equations</a><a id="Equations-1"></a><a class="docs-heading-anchor-permalink" href="#Equations" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>This follows what is <em>currently</em> implemented in <code>examples</code>: it should be kept up-to-date as code is modified. If you think something <em>should</em> be changed (but hasn&#39;t been), please add a note.</p></div></div><p>This describes the ClimaAtmos model equations and its discretizations. Where possible, we use a coordinate invariant form: the ClimaCore operators generally handle the conversions between bases internally.</p><h2 id="Prognostic-variables"><a class="docs-heading-anchor" href="#Prognostic-variables">Prognostic variables</a><a id="Prognostic-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Prognostic-variables" title="Permalink"></a></h2><ul><li><span>$\rho$</span>: <em>density</em> in kg/m³. This is discretized at cell centers.</li><li><span>$\boldsymbol{u}$</span> <em>velocity</em>, a vector in m/s. This is discretized via <span>$\boldsymbol{u} = \boldsymbol{u}_h + \boldsymbol{u}_v$</span> where<ul><li><span>$\boldsymbol{u}_h = u_1 \boldsymbol{e}^1 + u_2 \boldsymbol{e}^2$</span> is the projection onto horizontal covariant components (covariance here means with respect to the reference element), stored at cell centers.</li><li><span>$\boldsymbol{u}_v = u_3 \boldsymbol{e}^3$</span> is the projection onto the vertical covariant components, stored at cell faces.</li></ul></li><li><em>energy</em>, stored at cell centers; can be either:<ul><li><span>$\rho e$</span>: <em>total energy</em> in J/m³</li><li><span>$\rho e_\text{int}$</span>: <em>internal energy</em> in J/m³</li></ul></li><li><span>$\rho \chi$</span>: <em>other conserved scalars</em> (moisture, tracers, etc), again stored at cell centers.</li></ul><h2 id="Operators"><a class="docs-heading-anchor" href="#Operators">Operators</a><a id="Operators-1"></a><a class="docs-heading-anchor-permalink" href="#Operators" title="Permalink"></a></h2><p>We make use of the following operators</p><h3 id="Reconstruction"><a class="docs-heading-anchor" href="#Reconstruction">Reconstruction</a><a id="Reconstruction-1"></a><a class="docs-heading-anchor-permalink" href="#Reconstruction" title="Permalink"></a></h3><ul><li><span>$I^c$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.InterpolateF2C">face-to-center reconstruction operator</a> (arithmetic mean)</li><li><span>$I^f$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.InterpolateC2F">center-to-face reconstruction operator</a> (arithmetic mean)</li><li><span>$WI^f$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeightedInterpolateC2F">center-to-face weighted reconstruction operator</a><ul><li><span>$WI^f(J, x) = I^f(J*x) / I^f(J)$</span>, where <span>$J$</span> is the value of the Jacobian for use in the weighted interpolation operator</li></ul></li><li><span>$U^f$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Upwind3rdOrderBiasedProductC2F">1st or 3rd-order center-to-face upwind product operator</a> # fix link</li></ul><h3 id="Differential-operators"><a class="docs-heading-anchor" href="#Differential-operators">Differential operators</a><a id="Differential-operators-1"></a><a class="docs-heading-anchor-permalink" href="#Differential-operators" title="Permalink"></a></h3><ul><li><span>$\hat{\mathcal{D}}_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakDivergence">discrete horizontal spectral weak divergence</a>.</li><li><span>$\mathcal{D}^c_v$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.DivergenceF2C">face-to-center vertical divergence</a>.</li></ul><div class="admonition is-category-todo"><header class="admonition-header">Todo</header><div class="admonition-body"><p>Add vertical diffusive tendencies (including surface fluxes)</p></div></div><ul><li><span>$\mathcal{G}_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Gradient">discrete horizontal spectral gradient</a>.</li><li><span>$\mathcal{G}^f_v$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.GradientC2F">center-to-face vertical gradient</a>.<ul><li>the gradient is set to 0 at the top and bottom boundaries.</li></ul></li><li><span>$\mathcal{C}_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.Curl">curl components involving horizontal derivatives</a><ul><li><span>$\mathcal{C}_h[\boldsymbol{u}_h]$</span> returns a vector with only vertical <em>contravariant</em> components.</li><li><span>$\mathcal{C}_h[\boldsymbol{u}_v]$</span> returns a vector with only horizontal <em>contravariant</em> components.</li></ul></li><li><span>$\hat{\mathcal{C}}_h$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.WeakCurl">weak curl components involving horizontal derivatives</a></li><li><span>$\mathcal{C}^f_v$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#ClimaCore.Operators.CurlC2F">center-to-face curl involving vertical derivatives</a>.<ul><li><span>$\mathcal{C}^f_v[\boldsymbol{u}_h]$</span> returns a vector with only a horizontal <em>contravariant</em> component.</li><li>the curl is set to 0 at the top and bottom boundaries.<ul><li>We need to clarify how best to handle this.</li></ul></li></ul></li></ul><h3 id="Projection"><a class="docs-heading-anchor" href="#Projection">Projection</a><a id="Projection-1"></a><a class="docs-heading-anchor-permalink" href="#Projection" title="Permalink"></a></h3><ul><li><span>$\mathcal{P}$</span> is the <a href="https://clima.github.io/ClimaCore.jl/stable/operators/#DSS">direct stiffness summation (DSS) operation</a>, which computes the projection onto the continuous spectral element basis.</li></ul><h2 id="Auxiliary-and-derived-quantities"><a class="docs-heading-anchor" href="#Auxiliary-and-derived-quantities">Auxiliary and derived quantities</a><a id="Auxiliary-and-derived-quantities-1"></a><a class="docs-heading-anchor-permalink" href="#Auxiliary-and-derived-quantities" title="Permalink"></a></h2><ul><li><p><span>$\boldsymbol{\Omega}$</span> is the planetary angular velocity. We currently use a shallow-atmosphere approximation, with</p><p class="math-container">\[\boldsymbol{\Omega} = \Omega \sin(\phi) \boldsymbol{e}^v\]</p><p>where <span>$\phi$</span> is latitude, and <span>$\Omega$</span> is the planetary rotation rate in rads/sec (for Earth, <span>$7.29212 \times 10^{-5} s^{-1}$</span>) and <span>$\boldsymbol{e}^v$</span> is the unit radial basis vector. This implies that the horizontal contravariant component <span>$\boldsymbol{\Omega}^h$</span> is zero.</p></li><li><p><span>$\tilde{\boldsymbol{u}}$</span> is the mass-weighted reconstruction of velocity at the interfaces: by interpolation of contravariant components</p><p class="math-container">\[\tilde{\boldsymbol{u}} = WI^f(\rho J, \boldsymbol{u}_h) + \boldsymbol{u}_v\]</p></li><li><p><span>$\bar{\boldsymbol{u}}$</span> is the reconstruction of velocity at cell-centers, carried out by linear interpolation of the covariant vertical component:</p><p class="math-container">\[\bar{\boldsymbol{u}} = \boldsymbol{u}_h + I_{c}(\boldsymbol{u}_v)\]</p></li><li><p><span>$\Phi = g z$</span> is the geopotential, where <span>$g$</span> is the gravitational acceleration rate and <span>$z$</span> is altitude above the mean sea level.</p></li><li><p><span>$\boldsymbol{b}$</span> is the reduced gravitational acceleration</p><p class="math-container">\[\boldsymbol{b} = - \frac{\rho - \rho_{\text{ref}}}{\rho} \nabla \Phi\]</p></li><li><p><span>$\rho_{\text{ref}}$</span> is the reference state density</p></li><li><p><span>$K = \tfrac{1}{2} \|\boldsymbol{u}\|^2$</span> is the specific kinetic energy (J/kg), reconstructed at cell centers by</p><p class="math-container">\[K = \tfrac{1}{2} (\boldsymbol{u}_{h} \cdot \boldsymbol{u}_{h} + 2 \boldsymbol{u}_{h} \cdot I_{c} (\boldsymbol{u}_{v}) + I_{c}(\boldsymbol{u}_{v} \cdot \boldsymbol{u}_{v})),\]</p><p>where <span>$\boldsymbol{u}_{h}$</span> is defined on cell-centers, <span>$\boldsymbol{u}_{v}$</span> is defined on cell-faces, and <span>$I_{c} (\boldsymbol{u}_{v})$</span> is interpolated using covariant components.</p></li><li><p><span>$p$</span> is air pressure, derived from the thermodynamic state, reconstructed at cell centers.</p></li><li><p><span>$p_{\text{ref}}$</span> is the reference state pressure. It is related to the reference state density by analytical hydrostatic balance: <span>$\nabla p_{\text{ref}} = - \rho_{\text{ref}} \nabla \Phi$</span>.</p></li><li><p><span>$\boldsymbol{F}_R$</span> are the radiative fluxes: these are assumed to align vertically (i.e. the horizontal contravariant components are zero), and are constructed at cell faces from <a href="https://github.com/CliMA/RRTMGP.jl">RRTMGP.jl</a>.</p></li><li><p><span>$\nu_u$</span>, <span>$\nu_h$</span>, and <span>$\nu_\chi$</span> are hyperdiffusion coefficients, and <span>$c$</span> is the divergence damping factor.</p></li><li><p>No-flux boundary conditions are enforced by requiring the third contravariant component of the face-valued velocity at the boundary, <span>$\boldsymbol{\tilde{u}}^{v}$</span>, to be zero. The vertical covariant velocity component is computed as</p><p class="math-container">\[\tilde{u}_{v} = \tfrac{-(u_{1}g^{31} + u_{2}g^{32})}{g^{33}}.\]</p></li></ul><h2 id="Equations-and-discretizations"><a class="docs-heading-anchor" href="#Equations-and-discretizations">Equations and discretizations</a><a id="Equations-and-discretizations-1"></a><a class="docs-heading-anchor-permalink" href="#Equations-and-discretizations" title="Permalink"></a></h2><h3 id="Mass"><a class="docs-heading-anchor" href="#Mass">Mass</a><a id="Mass-1"></a><a class="docs-heading-anchor-permalink" href="#Mass" title="Permalink"></a></h3><p>Follows the continuity equation</p><p class="math-container">\[\frac{\partial}{\partial t} \rho = - \nabla \cdot(\rho \boldsymbol{u}) + \rho \mathcal{S}_{qt}.\]</p><p>This is discretized using the following</p><p class="math-container">\[\frac{\partial}{\partial t} \rho
= - \hat{\mathcal{D}}_h[ \rho \bar{\boldsymbol{u}}] - \mathcal{D}^c_v \left[WI^f( J, \rho) \tilde{\boldsymbol{u}} \right] + \rho \mathcal{S}_{qt}\]</p><p>with the</p><p class="math-container">\[-\mathcal{D}^c_v[WI^f(J, \rho) \boldsymbol{u}_v]\]</p><p>term treated implicitly (check this)</p><h3 id="Momentum"><a class="docs-heading-anchor" href="#Momentum">Momentum</a><a id="Momentum-1"></a><a class="docs-heading-anchor-permalink" href="#Momentum" title="Permalink"></a></h3><p>Uses the advective form equation</p><p class="math-container">\[\frac{\partial}{\partial t} \boldsymbol{u}  = - (2 \boldsymbol{\Omega} + \nabla \times \boldsymbol{u}) \times \boldsymbol{u} - \frac{1}{\rho} \nabla (p - p_{\text{ref}})  + \boldsymbol{b} - \nabla K\]</p><h4 id="Horizontal-momentum"><a class="docs-heading-anchor" href="#Horizontal-momentum">Horizontal momentum</a><a id="Horizontal-momentum-1"></a><a class="docs-heading-anchor-permalink" href="#Horizontal-momentum" title="Permalink"></a></h4><p>By breaking the curl and cross product terms into horizontal and vertical contributions, and removing zero terms (e.g. <span>$\nabla_v  \times \boldsymbol{u}_v = 0$</span>), we obtain</p><p class="math-container">\[\frac{\partial}{\partial t} \boldsymbol{u}_h  =
  - (\nabla_v \times \boldsymbol{u}_h +  \nabla_h \times \boldsymbol{u}_v) \times \boldsymbol{u}^v
  - (2 \boldsymbol{\Omega}^v + \nabla_h \times \boldsymbol{u}_h) \times \boldsymbol{u}^h
  - \frac{1}{\rho} \nabla_h (p - p_{\text{ref}})  - \nabla_h (\Phi + K),\]</p><p>where <span>$\boldsymbol{u}^h$</span> and <span>$\boldsymbol{u}^v$</span> are the horizontal and vertical <em>contravariant</em> vectors. The effect of topography is accounted for through the computation of the contravariant velocity components (projections from the covariant velocity representation) prior to computing the cross-product contributions.</p><p>This is stabilized with the addition of 4th-order vector hyperviscosity</p><p class="math-container">\[-\nu_u \, \nabla_h^2 (\nabla_h^2(\boldsymbol{\overbar{u}})),\]</p><p>projected onto the first two contravariant directions, where <span>$\nabla_{h}^2(\boldsymbol{v})$</span> is the horizontal vector Laplacian. For grid scale hyperdiffusion, <span>$\boldsymbol{v}$</span> is identical to <span>$\boldsymbol{\overbar{u}}$</span>, the cell-center valued velocity vector.</p><p class="math-container">\[\nabla_h^2(\boldsymbol{v}) = \nabla_h(\nabla_{h} \cdot \boldsymbol{v}) - \nabla_{h} \times (\nabla_{h} \times \boldsymbol{v}).\]</p><p>The <span>$(\nabla_v \times \boldsymbol{u}_h + \nabla_h \times \boldsymbol{u}_v) \times \boldsymbol{u}^v$</span> term is discretized as:</p><p class="math-container">\[\frac{I^c((\mathcal{C}^f_v[\boldsymbol{u}_h] + \mathcal{C}_h[\boldsymbol{u}_v]) \times (I^f(\rho J)\tilde{\boldsymbol{u}}^v))}{\rho J}\]</p><p>where</p><p class="math-container">\[\omega^{h} = (\nabla_v \times \boldsymbol{u}_h + \nabla_h \times \boldsymbol{u}_v)\]</p><p>The <span>$(2 \boldsymbol{\Omega}^v + \nabla_h \times \boldsymbol{u}_h) \times \boldsymbol{u}^h$</span> term is discretized as</p><p class="math-container">\[(2 \boldsymbol{\Omega}^v + \mathcal{C}_h[\boldsymbol{u}_h]) \times \boldsymbol{u}^h\]</p><p>and the <span>$\frac{1}{\rho} \nabla_h (p - p_h)  + \nabla_h (\Phi + K)$</span> as</p><p class="math-container">\[\frac{1}{\rho} \mathcal{G}_h[p - p_{\text{ref}}] + \mathcal{G}_h[\Phi + K] ,\]</p><p>where all these terms are treated explicitly.</p><p>The hyperviscosity term is</p><p class="math-container">\[- \nu_u \left\{ c \, \hat{\mathcal{G}}_h ( \mathcal{D}(\boldsymbol{\psi}_h) ) - \hat{\mathcal{C}}_h( \mathcal{C}_h( \boldsymbol{\psi}_h )) \right\}\]</p><p>where</p><p class="math-container">\[\boldsymbol{\psi}_h = \mathcal{P} \left[ \hat{\mathcal{G}}_h ( \mathcal{D}(\boldsymbol{u}_h) ) - \hat{\mathcal{C}}_h( \mathcal{C}_h( \boldsymbol{u}_h )) \right]\]</p><h4 id="Vertical-momentum"><a class="docs-heading-anchor" href="#Vertical-momentum">Vertical momentum</a><a id="Vertical-momentum-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-momentum" title="Permalink"></a></h4><p>Similarly for vertical velocity</p><p class="math-container">\[\frac{\partial}{\partial t} \boldsymbol{u}_v  =
  - (\nabla_v \times \boldsymbol{u}_h + \nabla_h \times \boldsymbol{u}_v) \times \boldsymbol{u}^h
  - \frac{1}{\rho} \nabla_v (p - p_{\text{ref}}) - \frac{\rho - \rho_{\text{ref}}}{\rho} \nabla_v \Phi - \nabla_v K .\]</p><p>The <span>$(\nabla_v \times \boldsymbol{u}_h + \nabla_h \times \boldsymbol{u}_v) \times \boldsymbol{u}^h$</span> term is discretized as</p><p class="math-container">\[(\mathcal{C}^f_v[\boldsymbol{u}_h] + \mathcal{C}_h[\boldsymbol{u}_v]) \times I^f(\boldsymbol{u}^h) ,\]</p><p>and the <span>$\frac{1}{\rho} \nabla_v (p - p_{\text{ref}}) - \frac{\rho - \rho_{\text{ref}}}{\rho} \nabla_v \Phi - \nabla_v K$</span> term as</p><p class="math-container">\[\frac{1}{I^f(\rho)} \mathcal{G}^f_v[p - p_{\text{ref}}] - \frac{I^f(\rho - \rho_{\text{ref}})}{I^f(\rho)} \mathcal{G}^f_v[\Phi] - \mathcal{G}^f_v[K] ,\]</p><p>with the latter treated implicitly.</p><p>This is stabilized with the addition of 4th-order vector hyperviscosity</p><p class="math-container">\[-\nu_u \, \nabla_h^2 (\nabla_h^2(\boldsymbol{\overbar{u}})),\]</p><p>projected onto the third contravariant direction.</p><h3 id="Total-energy"><a class="docs-heading-anchor" href="#Total-energy">Total energy</a><a id="Total-energy-1"></a><a class="docs-heading-anchor-permalink" href="#Total-energy" title="Permalink"></a></h3><p class="math-container">\[\frac{\partial}{\partial t} \rho e = - \nabla \cdot((\rho e + p) \boldsymbol{u} + \boldsymbol{F}_R) + \rho \mathcal{S}_{e},\]</p><p>which is stabilized with the addition of a 4th-order hyperdiffusion term on total enthalpy:</p><p class="math-container">\[- \nu_h \nabla \cdot \left( \rho \nabla^3 \left(\frac{ρe + p}{ρ} \right)\right)\]</p><p>This is discretized using</p><p class="math-container">\[\frac{\partial}{\partial t} \rho e \approx
- \hat{\mathcal{D}}_h[ (\rho e + p) \bar{\boldsymbol{u}} ]
- \mathcal{D}^c_v \left[ WI^f(J,\rho) \,  \tilde{\boldsymbol{u}} \, I^f \left(\frac{\rho e + p}{\rho} \right)
  + \boldsymbol{F}_R \right] - \nu_h \hat{\mathcal{D}}_h( \rho \mathcal{G}_h(\psi) ).\]</p><p>where</p><p class="math-container">\[\psi = \mathcal{P} \left[ \hat{\mathcal{D}}_h \left( \mathcal{G}_h \left(\frac{ρe + p}{ρ} \right)\right) \right]\]</p><p>Currently the central reconstruction</p><p class="math-container">\[- \mathcal{D}^c_v \left[ WI^f(J,\rho) \,  \tilde{\boldsymbol{u}} \, I^f \left(\frac{\rho e + p}{\rho} \right) \right]\]</p><p>is treated implicitly.</p><div class="admonition is-category-todo"><header class="admonition-header">Todo</header><div class="admonition-body"><p>The Jacobian computation should be updated so that the upwinded term</p><p class="math-container">\[- \mathcal{D}^c_v\left[WI^f(J, \rho) U^f\left(\boldsymbol{u}_v, \frac{\rho e + p}{\rho} \right)\right]\]</p><p>is treated implicitly.</p></div></div><h3 id="Scalars"><a class="docs-heading-anchor" href="#Scalars">Scalars</a><a id="Scalars-1"></a><a class="docs-heading-anchor-permalink" href="#Scalars" title="Permalink"></a></h3><p>For an arbitrary scalar <span>$\chi$</span>, the density-weighted scalar <span>$\rho\chi$</span> follows the continuity equation</p><p class="math-container">\[\frac{\partial}{\partial t} \rho \chi = - \nabla \cdot(\rho \chi \boldsymbol{u}) + \rho \mathcal{S}_{\chi}.\]</p><p>This is stabilized with the addition of a 4th-order hyperdiffusion term</p><p class="math-container">\[- \nu_\chi \nabla \cdot(\rho \nabla^3(\chi))\]</p><p>This is discretized using</p><p class="math-container">\[\frac{\partial}{\partial t} \rho \chi \approx
- \hat{\mathcal{D}}_h[ \rho \chi \bar{\boldsymbol{u}}]
- \mathcal{D}^c_v \left[ WI^f(J,\rho) \, U^f\left( \tilde{\boldsymbol{u}},  \frac{\rho \chi}{\rho} \right) \right]
- \nu_\chi \hat{\mathcal{D}}_h ( \rho \, \mathcal{G}_h (\psi) )\]</p><p>where</p><p class="math-container">\[\psi = \mathcal{P} \left[ \hat{\mathcal{D}}_h \left( \mathcal{G}_h \left( \frac{\rho \chi}{\rho} \right)\right) \right]\]</p><p>Currently the central reconstruction</p><p class="math-container">\[- \mathcal{D}^c_v \left[ WI^f(J,\rho) \, \tilde{\boldsymbol{u}} \, I^f\left( \frac{\rho \chi}{\rho} \right) \right]\]</p><p>is treated implicitly.</p><div class="admonition is-category-todo"><header class="admonition-header">Todo</header><div class="admonition-body"><p>The Jacobian computation should be updated so that the upwinded term</p><p class="math-container">\[- \mathcal{D}^c_v\left[WI^f(J, \rho) U^f\left(I^f(\boldsymbol{u}_h) + \boldsymbol{u}_v, \frac{\rho \chi}{\rho} \right) \right]\]</p><p>is treated implicitly.</p></div></div><h2 id="Microphysics-source-terms"><a class="docs-heading-anchor" href="#Microphysics-source-terms">Microphysics source terms</a><a id="Microphysics-source-terms-1"></a><a class="docs-heading-anchor-permalink" href="#Microphysics-source-terms" title="Permalink"></a></h2><p>Sources from cloud microphysics <span>$\mathcal{S}$</span> represent the transfer of mass   between the working fluid (dry air, water vapor cloud liquid and cloud ice)   and precipitation (rain and snow),   as well as the latent heat release due to phase changes.</p><p>The scalars <span>$\rho q_{rai}$</span> and <span>$\rho q_{sno}$</span> are part of the state vector   when running simulations with 1-moment microphysics scheme,   and represent the specific humidity of liquid and solid precipitation   (i.e. rain and snow).</p><p class="math-container">\[q_{rai} := \frac{m_{rai}}{m_{dry} + m_{vap} + m_{liq} + m_{ice}}\; ,
\;\;\;\;
q_{sno} := \frac{m_{sno}}{m_{dry} + m_{vap} + m_{liq} + m_{ice}}\]</p><p>The different source terms are provided by   <a href="https://github.com/CliMA/CloudMicrophysics.jl">CloudMicrophysics.jl</a> library   and are defined as the change of mass of one of the cloud condensate or   precipitation species normalised by the mass of the working fluid. See the <a href="https://clima.github.io/CloudMicrophysics.jl/dev/">CloudMicrophysics.jl docs</a>   for more details.</p><div class="admonition is-category-todo"><header class="admonition-header">Todo</header><div class="admonition-body"><p>Throughout the rest of the derivations we are assuming that the volume of the working fluid is constant (not the pressure). This is strange for phase changes and needs more thinking.</p></div></div><h3 id="Case-1:-Mass-of-the-working-fluid-is-changed"><a class="docs-heading-anchor" href="#Case-1:-Mass-of-the-working-fluid-is-changed">Case 1: Mass of the working fluid is changed</a><a id="Case-1:-Mass-of-the-working-fluid-is-changed-1"></a><a class="docs-heading-anchor-permalink" href="#Case-1:-Mass-of-the-working-fluid-is-changed" title="Permalink"></a></h3><p>When the phase change is happening within the working fluid   (for example condensation from water vapor to liquid water),   there is no change to any of the state variables. Considering the transition from   <span>$x \rightarrow y$</span> where <span>$x$</span> is either    water vapor, cloud liquid water or cloud ice and   <span>$y$</span> is either rain or snow</p><p class="math-container">\[\mathcal{S}_{x \rightarrow y} := \frac{\frac{dm_x}{dt}}{m_{dry} + m_{vap} + m_{liq} + m_{ice}}\]</p><p class="math-container">\[\frac{d}{dt} \rho =
\frac{d}{dt} \rho q_{tot} =
\rho \mathcal{S}_{x \rightarrow y} =
- \frac{d}{dt} \rho q_y\]</p><p class="math-container">\[\frac{d}{dt} \rho e = \rho \mathcal{S}_{x \rightarrow y} (I_{y} + \Phi)\]</p><p>where <span>$I_{y}$</span> is the internal energy of the <span>$y$</span> phase. This formula applies to the majority of microphysics processes. Namely, it is valid for processes where <span>$T=const$</span> such as   autoconversion and accretion between species of the same phase. It is also valid for rain evaporation, deposition/sublimation, and   accretion of cloud water and snow in temperatures below freezing   (which result in snow).</p><h3 id="Case-2:-Phase-change-outside-of-the-working-fluid"><a class="docs-heading-anchor" href="#Case-2:-Phase-change-outside-of-the-working-fluid">Case 2: Phase change outside of the working fluid</a><a id="Case-2:-Phase-change-outside-of-the-working-fluid-1"></a><a class="docs-heading-anchor-permalink" href="#Case-2:-Phase-change-outside-of-the-working-fluid" title="Permalink"></a></h3><p>For cases where both <span>$x$</span> and <span>$y$</span> are not part of the working fluid   (melting of snow, freezing of rain)</p><p class="math-container">\[\mathcal{S}_{x \rightarrow y} := \frac{\frac{dm_{x}}{dt}}{m_{dry} + m_{vap} + m_{liq} + m_{ice}}\]</p><p class="math-container">\[\frac{d}{dt} \rho q_{x} =
- \frac{d}{dt} \rho q_{y} =
\rho \mathcal{S}_{x \rightarrow y}\]</p><p class="math-container">\[\frac{d}{dt} \rho = \frac{d}{dt} \rho q_{tot} = 0\]</p><p class="math-container">\[\frac{d}{dt} \rho e = - \rho \mathcal{S}_{x \rightarrow y} L_{f}\]</p><p>where <span>$L_f$</span> is the latent heat of fusion. The sign in the last equation assumes <span>$x$</span> stands for rain and <span>$y$</span> for snow.</p><h3 id="Additional-cases"><a class="docs-heading-anchor" href="#Additional-cases">Additional cases</a><a id="Additional-cases-1"></a><a class="docs-heading-anchor-permalink" href="#Additional-cases" title="Permalink"></a></h3><p>Accretion of cloud ice by rain results in snow. This process combines the effects from the loss of working fluid <span>$q_{ice}$</span>    (described by case 1)    and the phase change from rain to snow    (described by case 2).</p><p>Accretion of cloud liquid by snow in temperatures above freezing results in rain. It is assummed that some fraction <span>$\alpha$</span> of snow is melted during the process   and both cloud liquid and melted snow are turned into rain.</p><p class="math-container">\[\mathcal{S}_{acc} := \frac{\frac{dm_{liq}}{dt}}{m_{dry} + m_{vap} + m_{liq} + m_{ice}}\]</p><p class="math-container">\[\frac{d}{dt} \rho = \frac{d}{dt} \rho q_{tot} = \rho S_{acc}\]</p><p class="math-container">\[\frac{d}{dt} \rho q_{sno} = \rho \alpha S_{acc}\]</p><p class="math-container">\[\frac{d}{dt} \rho q_{rai} = - \rho (1 + \alpha) S_{acc}\]</p><p class="math-container">\[\frac{d}{dt} \rho e = \rho \mathcal{S}_{acc} ((1+\alpha) I_{liq} - \alpha I_{ice} + \Phi)\]</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../contributor_guide/">« Contributor Guide</a><a class="docs-footer-nextpage" href="../edmf_equations/">EDMF Equations »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Thursday 25 January 2024 20:34">Thursday 25 January 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
