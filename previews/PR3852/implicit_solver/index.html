<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implicit Solver · ClimaAtmos.jl</title><meta name="title" content="Implicit Solver · ClimaAtmos.jl"/><meta property="og:title" content="Implicit Solver · ClimaAtmos.jl"/><meta property="twitter:title" content="Implicit Solver · ClimaAtmos.jl"/><meta name="description" content="Documentation for ClimaAtmos.jl."/><meta property="og:description" content="Documentation for ClimaAtmos.jl."/><meta property="twitter:description" content="Documentation for ClimaAtmos.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaAtmos.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaAtmos.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../contributor_guide/">Contributor Guide</a></li><li><a class="tocitem" href="../equations/">Equations</a></li><li><a class="tocitem" href="../edmf_equations/">EDMF Equations</a></li><li><a class="tocitem" href="../diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../available_diagnostics/">Available Diagnostics</a></li><li><a class="tocitem" href="../diagnostic_edmf_equations/">Diagnostic EDMF Equations</a></li><li><a class="tocitem" href="../gravity_wave/">Gravity Wave Drag Parameterizations</a></li><li><a class="tocitem" href="../surface_albedo/">Ocean Surface Albedo Parameterization</a></li><li><a class="tocitem" href="../topography/">Topography Representation</a></li><li><a class="tocitem" href="../tracers/">Tracers</a></li><li class="is-active"><a class="tocitem" href>Implicit Solver</a><ul class="internal"><li><a class="tocitem" href="#Computing-the-Jacobian"><span>Computing the Jacobian</span></a></li><li><a class="tocitem" href="#See-also"><span>See also</span></a></li></ul></li><li><a class="tocitem" href="../radiative_equilibrium/">Radiative Equilibrium</a></li><li><a class="tocitem" href="../single_column_prospect/">Single Column Model</a></li><li><a class="tocitem" href="../restarts/">Restarts and checkpoints</a></li><li><a class="tocitem" href="../repl_scripts/">REPL scripts</a></li><li><a class="tocitem" href="../config/">Configuration</a></li><li><a class="tocitem" href="../parameters/">Parameters</a></li><li><a class="tocitem" href="../longruns/">Longruns</a></li><li><a class="tocitem" href="../itime/">The time type</a></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Implicit Solver</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implicit Solver</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaAtmos.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaAtmos.jl/blob/main/docs/src/implicit_solver.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Implicit-Solver"><a class="docs-heading-anchor" href="#Implicit-Solver">Implicit Solver</a><a id="Implicit-Solver-1"></a><a class="docs-heading-anchor-permalink" href="#Implicit-Solver" title="Permalink"></a></h1><p>The state <span>$Y$</span> is evolved using a split implicit-explicit (IMEX) timestepping scheme, which separates the tendency <span>$T(Y) = \partial Y/\partial t$</span> into implicit (fast) and explicit (slow) components,</p><p class="math-container">\[T(Y) = T_{imp}(Y) + T_{exp}(Y).\]</p><p>For an implicit step from time <span>$t$</span> to <span>$t + \Delta t$</span>, we begin with the state <span>$Y_{prev}$</span> from the explicit step at time <span>$t$</span> (which also includes information from all previous times before <span>$t$</span>), and we find a state <span>$Y$</span> that solves the implicit equation</p><p class="math-container">\[Y = Y_{prev} + \Delta t * T_{imp}(Y),\]</p><p>where <span>$\Delta t * T_{imp}(Y)$</span> is a linear approximation of the state change due to the implicit tendency between times <span>$t$</span> and <span>$t + \Delta t$</span>. Solving this equation amounts to finding a root of the residual function</p><p class="math-container">\[R(Y) = Y_{prev} + \Delta t * T_{imp}(Y) - Y,\]</p><p>since any state <span>$Y$</span> that satisfies <span>$R(Y) = 0$</span> is consistent with the linear approximation of the implicit state change.</p><p><em>Note:</em> When we use a higher-order timestepping scheme, the full step <span>$\Delta t$</span> is divided into several sub-steps or &quot;stages&quot;, where the duration of stage <span>$i$</span> is <span>$\Delta t * γ_i$</span> for some constant <span>$γ_i$</span> between 0 and 1.</p><p>To find the root of <span>$R(Y)$</span> using Newton&#39;s method, we must specify the derivative <span>$\partial R/\partial Y$</span>. Since <span>$Y_{prev}$</span> does not depend on <span>$Y$</span> (it is only a function of the state at or before time <span>$t$</span>), this derivative is given by</p><p class="math-container">\[R&#39;(Y) = \Delta t * \frac{\partial T_{imp}}{\partial Y} - I.\]</p><p>For each state <span>$Y$</span>, Newton&#39;s method computes an update <span>$\Delta Y$</span> that brings <span>$R(Y)$</span> closer to 0 by solving the linear equation</p><p class="math-container">\[R&#39;(Y) * \Delta Y = R(Y).\]</p><p><em>Note:</em> This equation comes from assuming that there is some <span>$\Delta Y$</span> for which <span>$R(Y - \Delta Y) = 0$</span> and approximating</p><p class="math-container">\[R(Y - \Delta Y) \approx R(Y) - R&#39;(Y) * \Delta Y.\]</p><p>After initializing <span>$Y$</span> to <span>$Y[0] = Y_{prev}$</span>, Newton&#39;s method executes the following steps:</p><ol><li>Compute the residual <span>$R(Y[0])$</span> and its derivative <span>$R&#39;(Y[0])$</span>.</li><li>Solve <span>$R&#39;(Y[0]) * \Delta Y[0] = R(Y[0])$</span> for <span>$\Delta Y[0]$</span>.</li><li>Update <span>$Y$</span> to <span>$Y[1] = Y[0] - \Delta Y[0]$</span>.</li></ol><p>If the number of Newton iterations is limited to 1, this new value of <span>$Y$</span> is taken to be the solution of the implicit equation. Otherwise, this sequence of steps is repeated, i.e., <span>$\Delta Y[1]$</span> is computed and <span>$Y$</span> is updated to <span>$Y[2] = Y[1] - \Delta Y[1]$</span>, then <span>$\Delta Y[2]$</span> is computed and <span>$Y$</span> is updated to <span>$Y[3] = Y[2] - \Delta Y[2]$</span>, and so on until the maximum number of iterations is reached.</p><h2 id="Computing-the-Jacobian"><a class="docs-heading-anchor" href="#Computing-the-Jacobian">Computing the Jacobian</a><a id="Computing-the-Jacobian-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-the-Jacobian" title="Permalink"></a></h2><p>The derivative <span>$\partial R/\partial Y$</span> is represented as a <a href="../api/#ClimaAtmos.Jacobian"><code>ClimaAtmos.Jacobian</code></a>, and the method for computing it and solving its linear equation is given by a <a href="../api/#ClimaAtmos.JacobianAlgorithm"><code>ClimaAtmos.JacobianAlgorithm</code></a>.</p><h3 id="Manual-Differentiation"><a class="docs-heading-anchor" href="#Manual-Differentiation">Manual Differentiation</a><a id="Manual-Differentiation-1"></a><a class="docs-heading-anchor-permalink" href="#Manual-Differentiation" title="Permalink"></a></h3><p>By making certain assumptions about the physical significance of each block in the Jacobian (see Yatunin et al., Appendix F), we can obtain a sparse matrix structure that allows for an efficient linear solver. Specifically, the memory required for the sparse matrix and the time required for the linear solver both scale linearly with the number of values in each column.</p><p>To populate the nonzero entries of this sparse matrix, the <a href="../api/#ClimaAtmos.ManualSparseJacobian"><code>ClimaAtmos.ManualSparseJacobian</code></a> specifies approximate derivatives for all possible configurations of the atmosphere model, which are analytically derived from expressions used to compute the implicit tendency. This algorithm also provides flags for zeroing out blocks of the sparse matrix, where each flag corresponds to the implicit treatment of some particular physical process.</p><h3 id="Dense-Automatic-Differentiation"><a class="docs-heading-anchor" href="#Dense-Automatic-Differentiation">Dense Automatic Differentiation</a><a id="Dense-Automatic-Differentiation-1"></a><a class="docs-heading-anchor-permalink" href="#Dense-Automatic-Differentiation" title="Permalink"></a></h3><p>Another way to compute the Jacobian is through automatic differentiation. This involves replacing all real numbers with dual numbers of the form</p><p class="math-container">\[x^D = x + x&#39;_1 * \varepsilon_1 + x&#39;_2 * \varepsilon_2 + \ldots,\]</p><p>where </p><ul><li><span>$x$</span> and <span>$x&#39;_i$</span> are real numbers, and</li><li><span>$\varepsilon_i$</span> is an infinitesimal number with the property that <span>$\varepsilon_i * \varepsilon_j = 0$</span>.</li></ul><p>The <a href="../api/#ClimaAtmos.AutoDenseJacobian"><code>ClimaAtmos.AutoDenseJacobian</code></a> defines the dual counterpart of each column&#39;s state vector <span>$Y$</span> as</p><p class="math-container">\[Y^D = Y + \varepsilon =
\begin{pmatrix}
    Y_1 + \varepsilon_1 \\
    Y_2 + \varepsilon_2 \\
    \vdots \\
    Y_N + \varepsilon_N
\end{pmatrix},\]</p><p>where <span>$N$</span> is the number of values in the column. If <span>$x$</span> is a function of <span>$Y$</span>, evaluating <span>$x(Y^D)$</span> gives us</p><p class="math-container">\[x^D = x + \frac{\partial x}{\partial Y} * \varepsilon =
x + \frac{\partial x}{\partial Y_1} * \varepsilon_1 +
    \frac{\partial x}{\partial Y_2} * \varepsilon_2 + \ldots +
    \frac{\partial x}{\partial Y_N} * \varepsilon_N,\]</p><p>so that each coefficient <span>$x&#39;_i$</span> is a component of <span>$\partial x/\partial Y$</span>.</p><p><em>Note:</em> When there are many values in each column, the dual number components <span>$\varepsilon_i$</span> are split into batches to reduce compilation latency and runtime. Each batch requires a separate evaluation of <span>$x(Y^D)$</span>, but that evaluation involves fewer derivative coefficients and less compiled code.</p><p>After we initialize <span>$Y^D$</span> as shown above, we evaluate <span>$T_{imp}(Y^D)$</span> to obtain a dense representation of the matrix <span>$\partial T_{imp}/\partial Y$</span>,</p><p class="math-container">\[T_{imp}^D = T_{imp} + \frac{\partial T_{imp}}{\partial Y} * \varepsilon =
\begin{pmatrix}
    T_{imp, 1} + \frac{\partial T_{imp, 1}}{\partial Y_1} * \varepsilon_1 +
    \frac{\partial T_{imp, 1}}{\partial Y_2} * \varepsilon_2 + \ldots +
    \frac{\partial T_{imp, 1}}{\partial Y_N} * \varepsilon_N \\
    T_{imp, 2} + \frac{\partial T_{imp, 2}}{\partial Y_1} * \varepsilon_1 +
    \frac{\partial T_{imp, 2}}{\partial Y_2} * \varepsilon_2 + \ldots +
    \frac{\partial T_{imp, 2}}{\partial Y_N} * \varepsilon_N \\
    \vdots \\
    T_{imp, N} + \frac{\partial T_{imp, N}}{\partial Y_1} * \varepsilon_1 +
    \frac{\partial T_{imp, N}}{\partial Y_2} * \varepsilon_2 + \ldots +
    \frac{\partial T_{imp, N}}{\partial Y_N} * \varepsilon_N
\end{pmatrix},\]</p><p>where the entry in the <span>$i$</span>-th row and <span>$j$</span>-th column of <span>$\partial T_{imp}/\partial Y$</span> is the coefficient of <span>$\varepsilon_j$</span> in <span>$T_{imp, i}^D$</span>.</p><p><em>Note:</em> The implicit tendency is evaluated in two function calls. The first function <span>$p_{imp}(Y)$</span> computes cached values that are treated implicitly, and the second function <span>$T_{imp}(Y, p_{imp})$</span> computes the tendency itself. So, we first evaluate <span>$p_{imp}(Y^D)$</span> to get <span>$p_{imp}^D$</span>, and then we evaluate <span>$T_{imp}(Y^D, p_{imp}^D)$</span>.</p><p>The full dense Jacobian <span>$\partial R/\partial Y$</span> is computed as <span>$\Delta t * \partial T_{imp}/\partial Y - I$</span>, and its linear equation is solved using <a href="https://en.wikipedia.org/wiki/LU_decomposition">LU factorization</a>. The memory required for the dense matrix scales in proportion to <span>$N^2$</span>, and the time required for LU factorization scales as <span>$N^3$</span>.</p><h2 id="See-also"><a class="docs-heading-anchor" href="#See-also">See also</a><a id="See-also-1"></a><a class="docs-heading-anchor-permalink" href="#See-also" title="Permalink"></a></h2><ul><li><a href="https://doi.org/10.22541/essoar.173940262.23304403/v1">Yatunin, D, et al., &quot;The CliMA atmosphere dynamical core: Concepts, numerics, and scaling&quot;</a>, Section 5 and Appendix F</li><li><a href="https://clima.github.io/ClimaTimeSteppers.jl/dev/algorithm_formulations/ode_solvers/">Documentation for ClimaTimeSteppers.jl</a></li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tracers/">« Tracers</a><a class="docs-footer-nextpage" href="../radiative_equilibrium/">Radiative Equilibrium »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.12.0 on <span class="colophon-date" title="Tuesday 17 June 2025 17:12">Tuesday 17 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
