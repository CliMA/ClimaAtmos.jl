<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Perturbation Experiments · ClimaAtmos.jl</title><meta name="title" content="Perturbation Experiments · ClimaAtmos.jl"/><meta property="og:title" content="Perturbation Experiments · ClimaAtmos.jl"/><meta property="twitter:title" content="Perturbation Experiments · ClimaAtmos.jl"/><meta name="description" content="Documentation for ClimaAtmos.jl."/><meta property="og:description" content="Documentation for ClimaAtmos.jl."/><meta property="twitter:description" content="Documentation for ClimaAtmos.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaAtmos.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaAtmos.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation Instructions</a></li><li><a class="tocitem" href="../contributor_guide/">Contributor Guide</a></li><li><a class="tocitem" href="../equations/">Equations</a></li><li><a class="tocitem" href="../edmf_equations/">EDMF Equations</a></li><li><a class="tocitem" href="../diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../available_diagnostics/">Available Diagnostics</a></li><li><a class="tocitem" href="../diagnostic_edmf_equations/">Diagnostic EDMF Equations</a></li><li><a class="tocitem" href="../gravity_wave/">Gravity Wave Drag Parameterizations</a></li><li><a class="tocitem" href="../surface_albedo/">Ocean Surface Albedo Parameterization</a></li><li><a class="tocitem" href="../topography/">Topography Representation</a></li><li><a class="tocitem" href="../tracers/">Tracers</a></li><li><a class="tocitem" href="../implicit_solver/">Implicit Solver</a></li><li><a class="tocitem" href="../radiative_equilibrium/">Radiative Equilibrium</a></li><li><a class="tocitem" href="../single_column_prospect/">Single Column Model</a></li><li><a class="tocitem" href="../restarts/">Restarts and Checkpoints</a></li><li><a class="tocitem" href="../repl_scripts/">REPL scripts</a></li><li><input class="collapse-toggle" id="menuitem-18" type="checkbox" checked/><label class="tocitem" for="menuitem-18"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Perturbation Experiments</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Creating-Custom-Config-Arguments"><span>Creating Custom Config Arguments</span></a></li><li class="toplevel"><a class="tocitem" href="#Creating-and-Running-Ensembles"><span>Creating &amp; Running Ensembles</span></a></li><li class="toplevel"><a class="tocitem" href="#Visualizing-Ensemble-Output"><span>Visualizing Ensemble Output</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../config/">Configuration</a></li><li><a class="tocitem" href="../parameters/">Parameters</a></li><li><a class="tocitem" href="../longruns/">Longruns</a></li><li><a class="tocitem" href="../itime/">The time type</a></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Perturbation Experiments</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Perturbation Experiments</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaAtmos.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaAtmos.jl/blob/main/docs/src/perturbed_dycoms_rf02.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Perturbed-Initial-Conditions-Ensembles"><a class="docs-heading-anchor" href="#Perturbed-Initial-Conditions-Ensembles">Perturbed Initial Conditions Ensembles</a><a id="Perturbed-Initial-Conditions-Ensembles-1"></a><a class="docs-heading-anchor-permalink" href="#Perturbed-Initial-Conditions-Ensembles" title="Permalink"></a></h1><p>With a bit of setup, ClimaAtmos can be used to run ensembles of perturbed initial conditions. Here, we will use perturbed DYCOMS-RF02 initial conditions to create a spread of simulated marine stratocumulus clouds in a single column configuration with the EDMF scheme and 2-moment microphysics. As an example, we will create something similiar to the figure below (Hoffmann, 2020) using ClimaAtmos.</p><p><img src="../assets/Hoffmann2020.jpg" alt/></p><h1 id="Creating-Custom-Config-Arguments"><a class="docs-heading-anchor" href="#Creating-Custom-Config-Arguments">Creating Custom Config Arguments</a><a id="Creating-Custom-Config-Arguments-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-Custom-Config-Arguments" title="Permalink"></a></h1><p>In cases where it is of interest to run ensembles of the same model configuration but with perturbed initial conditions, it may be of use to add new keyword arguments to the .yml file. The idea is to allow modifications to initial conditions to be passed directly through the .yml file and then creating multiple copies of the files but with different variations and combinations of these parameters. </p><p>As an example, we will explore modifying the total water mixing ratio (<code>q_tot_0</code>), liquid-ice potential temperature profiles (<code>theta_0</code> &amp; <code>theta_i</code>), and initial boundary layer height (<code>z_i</code>) in the DYCOMS-RF02 simulation setup. </p><h3 id="Modify-initial_conditions.jl"><a class="docs-heading-anchor" href="#Modify-initial_conditions.jl">Modify initial_conditions.jl</a><a id="Modify-initial_conditions.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Modify-initial_conditions.jl" title="Permalink"></a></h3><p>To start, we need to go to the part of the source code responsible for defining the initial conditions. For both of the DYCOMS research flight simulation setups, the total water mixing ratio and liquid-ice potential temperature are pulled from another library called AtmosphericProfilesLibrary (APL).</p><p>There are many ways to modify the functions to allow for perturbation to the initial conditions, but for the sake of this example we will overwrite the function signature with our own version where we can pass in our own custom profiles. We must import the functions from the APL library and then define a new function with the same signature. This looks like:</p><pre><code class="nohighlight hljs">import AtmosphericProfilesLibrary: Dycoms_RF02_θ_liq_ice, Dycoms_RF02_q_tot
[...]

# Redefine the profile functions here. Here we redefine the functions such that 
# we can pass in our own values for q_tot and θ_liq_ice, as well as modifying 
# the initial boundary layer height.

&quot;&quot;&quot; [Ackerman2009](@cite) &quot;&quot;&quot;
Dycoms_RF02_θ_liq_ice(::Type{FT}, theta_0, theta_i, z_i) where {FT} =
    APL.ZProfile(z -&gt; if z &lt;= z_i
        FT(theta_0)
    else
        FT(theta_i) + (z - FT(z_i))^FT(1.0 / 3.0)
    end)

&quot;&quot;&quot; [Ackerman2009](@cite) &quot;&quot;&quot;
Dycoms_RF02_q_tot(::Type{FT}, q_tot_0, z_i) where {FT} =
    APL.ZProfile(z -&gt; if z &lt;= z_i
        FT(q_tot_0) / FT(1000.0)
    else
        (FT(5) - FT(3) * (FT(1) - exp(-(z - FT(z_i)) / FT(500)))) / FT(1000)
    end)</code></pre><p>Now that we have redefined our functions, we can pass these new functions to our intial conditions structure for the DYCOMS-RF02 setup. Here we can also begin to define our new keyword arguments that will serve as inputs for the new functions we defined. In the <code>DYCOMS_RF02</code> structure, we add the names of our new inputs:</p><pre><code class="nohighlight hljs">Base.@kwdef struct DYCOMS_RF02 &lt;: InitialCondition
    prognostic_tke::Bool = false
    q_tot_0_dycoms_rf02 # Define total water mixing ratio.
    theta_0_dycoms_rf02 # Define liquid-ice θ at surface.
    theta_i_dycoms_rf02 # Define liquid-ice θ at initial boundary layer height.
    z_i_dycoms_rf02 # Define initial boundary layer height.
end

for IC in (:Dycoms_RF01, :Dycoms_RF02)
    IC_Type = Symbol(uppercase(string(IC)))
    θ_func_name = Symbol(IC, :_θ_liq_ice)
    q_tot_func_name = Symbol(IC, :_q_tot)
    [...]
    if IC == :Dycoms_RF02
        @eval function (initial_condition::$IC_Type)(params)
            (; prognostic_tke, q_tot_0_dycoms_rf02, theta_0_dycoms_rf02, theta_i_dycoms_rf02, z_i_dycoms_rf02) = initial_condition #unpack the new arguments here. These arguments will be provided through the model .yml file.
            FT = eltype(params)
        [...]
            θ = $θ_func_name(FT, FT(theta_0_dycoms_rf02), FT(theta_i_dycoms_rf02), FT(z_i_dycoms_rf02)) # Change function signature here.
            q_tot = $q_tot_func_name(FT, FT(q_tot_0_dycoms_rf02), FT(z_i_dycoms_rf02)) # Change function signature here.
        end 
    else
        [...]
    end
end</code></pre><h3 id="Add-Keywords-to-.yml-and-Modify-default_config.yml"><a class="docs-heading-anchor" href="#Add-Keywords-to-.yml-and-Modify-default_config.yml">Add Keywords to .yml &amp; Modify default_config.yml</a><a id="Add-Keywords-to-.yml-and-Modify-default_config.yml-1"></a><a class="docs-heading-anchor-permalink" href="#Add-Keywords-to-.yml-and-Modify-default_config.yml" title="Permalink"></a></h3><p>Now that we have added a new keyword argument to be used in initial conditions, it is time to define the keyword argument in the YAML files responsible for configuring the model runs. In the YAML file for running a DYCOMS-RF02 single column experiment, we add and adjust the following lines: </p><pre><code class="nohighlight hljs">q_tot_0_dycoms_rf02: 9.45 # Define variables here.
theta_0_dycoms_rf02: 288.3 # Define variables here.
theta_i_dycoms_rf02: 295.0 # Define variables here.
z_i_dycoms_rf02: 795.0 # Define variables here.</code></pre><p>These are the same default values being used by the original APL function, but we can modify it in the YAML file if we want to test different initial conditions. Additionally, we need to provide a backup default value in the case that the keyword argument is not used or provided in the setup YAML file. To do this, we go to default_config.yml and add the following:</p><pre><code class="nohighlight hljs">q_tot_0_dycoms_rf02: # Additional variables here.
  help: &quot;Surface total water mixing ratio for DYCOMS RF02.&quot;
  value: 9.45 # Default value.
theta_0_dycoms_rf02: # Additional variables here.
  help: &quot;Surface liquid-ice potential temperature for DYCOMS RF02.&quot;
  value: 288.3 # Default value.
theta_i_dycoms_rf02: # Additional variables here.
  help: &quot;Initial boundary layer liquid-ice potential temperature for DYCOMS RF02.&quot;
  value: 295.0 # Default value.
z_i_dycoms_rf02: # Additional variables here.
  help: &quot;Initial boundary layer height.&quot;
  value: 795.0 # Default value.</code></pre><h3 id="Modify-type_getters.jl"><a class="docs-heading-anchor" href="#Modify-type_getters.jl">Modify type_getters.jl</a><a id="Modify-type_getters.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Modify-type_getters.jl" title="Permalink"></a></h3><p>Finally, we need to update type_getters.jl with our new keyword arguments as well. We find where DYCOMS-RF02 is specified and then we replace it with a separate block that looks like:</p><pre><code class="nohighlight hljs">[...]
    elseif parsed_args[&quot;initial_condition&quot;] == &quot;DYCOMS_RF02&quot;
        return getproperty(ICs, Symbol(parsed_args[&quot;initial_condition&quot;]))(
            parsed_args[&quot;prognostic_tke&quot;],
            parsed_args[&quot;q_tot_0_dycoms_rf02&quot;], # Add parsed args here.
            parsed_args[&quot;theta_0_dycoms_rf02&quot;], # Add parsed args here.
            parsed_args[&quot;theta_i_dycoms_rf02&quot;], # Add parsed args here.
            parsed_args[&quot;z_i_dycoms_rf02&quot;], # Add parsed args here.
        )
[...]</code></pre><p>With this step complete, we are now ready to pass a new keyword argument that we defined ourselves to modify or change the initial conditions. The scripts currently contained in /examples/perturbed<em>dycoms</em>rf02 contain code for running the ensemble as well as post-processing/plotting capabilities.</p><h1 id="Creating-and-Running-Ensembles"><a class="docs-heading-anchor" href="#Creating-and-Running-Ensembles">Creating &amp; Running Ensembles</a><a id="Creating-and-Running-Ensembles-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-and-Running-Ensembles" title="Permalink"></a></h1><p>All example scripts referenced are stored in examples/perturbed<em>dycoms</em>rf02:</p><pre><code class="nohighlight hljs">script_folder = joinpath(pkgdir(CA), &quot;examples&quot;, &quot;perturbed_dycoms_rf02&quot;)</code></pre><p>The script <code>pipeline.jl</code> handles this entire step without parallelized runs, but the steps can also be performed individually. </p><p>The recommended workflow is the create multiple copies of the .yml files and label them according to the initial conditions used. For example, the default file might look like <code>prognostic_edmfx_dycoms_rf02_column_qtot0_9.45_theta0_288.3_thetai_295.0_zi_795.0_prescribedN_1.0e8.yml</code>.</p><p>We can use <code>make_yaml.jl</code> to generate multiple different configurations with ease. To do so, provide the function <code>make_yamls()</code> with a default file for which to copy, and an output path. This script uses nested for loops to generate every possible combination of parameters, and they can be altered directly in the file. This might look like:</p><pre><code class="nohighlight hljs">include(joinpath(script_folder, &quot;make_yaml.jl&quot;))

default_data_path = default_prog_2M
output_dir = prognostic_2M_config
make_yamls(default_data_path, output_dir, is_prog=true)</code></pre><p>To use these configuration files, we can either parallelize or run them serially. If parallelization is desired, run: </p><pre><code class="nohighlight hljs">julia -p &lt;num_processors&gt; ./examples/perturbed_dycoms_rf02/parallel_driver.jl</code></pre><p>Be sure that the paths, which are handled by <code>all_paths.jl</code>, are referring to the right set of simulations. This example focuses in on prognostic EDMF+2M simulations, but the scripts have implementation for diagnostic EDMF as well as 1-moment microphysics as well.</p><h1 id="Visualizing-Ensemble-Output"><a class="docs-heading-anchor" href="#Visualizing-Ensemble-Output">Visualizing Ensemble Output</a><a id="Visualizing-Ensemble-Output-1"></a><a class="docs-heading-anchor-permalink" href="#Visualizing-Ensemble-Output" title="Permalink"></a></h1><p>After the simulations are done being ran, we can use <code>process_plot_outputs.jl</code> to visualize changes in the liquid water path (LWP) and cloud droplet number concentration (N), in order to recreate the figure above.</p><pre><code class="nohighlight hljs">include(joinpath(script_folder, &quot;process_plot_outputs.jl&quot;))

output_dir = &quot;./output&quot; #output_2M
all_outputs = make_edmf_vec(output_dir)
filtered = filter_runs(all_outputs)
# sampled = StatsBase.sample(filtered, 40; replace=false)

fig = plot_edmf(filtered, is_1M=false, is_time=false)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../repl_scripts/">« REPL scripts</a><a class="docs-footer-nextpage" href="../config/">Configuration »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Saturday 30 August 2025 00:29">Saturday 30 August 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
